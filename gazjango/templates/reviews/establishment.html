{% extends "base.html" %}
{% load extras %}

{% block title %}Community Guide{% endblock title %}

{% block customheader %}
  <link rel="stylesheet" href="{% static css page/section.css %}" type="text/css"/>
  <link rel="stylesheet" href="{% static css page/establishment.css %}" type="text/css"/>
  
  <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAG8P9j9QQO2vTUNEZdr-SshRLWsA0A4EVy0DFjwCAooQph_S49xRweBxq-VXWfeMAOnB19OX6LVP9Ww" type="text/javascript"></script>
  <script src="http://www.google.com/uds/solutions/localsearch/gmlocalsearch.js" type="text/javascript"></script> 
  
  {% jQuery %}
  
  <script type="text/javascript">
    var map;
    var directionsPanel;
    var directions;
    var travelMode;
    
    function createMarker(point, text, icon) {
		  var marker = new GMarker(point, icon);
		  // Show this marker's index in the info window when it is clicked
		  GEvent.addListener(marker, "click", function() {
			  marker.openInfoWindowHtml(text);
		  });

		  return marker;
	}
  
    function initialize() {
        
        map = new GMap2(document.getElementById("map"));
        map.setCenter(new GLatLng(39.9034, -75.3529), 15);
        map.addControl(new GMapTypeControl());
        map.addControl(new GLargeMapControl());
        map.addControl(new google.maps.LocalSearch(), new GControlPosition(G_ANCHOR_BOTTOM_RIGHT, new GSize(10,20)));
        
        
        {% ifequal establishment.access "p" %}
        var bicon = new GIcon();
        bicon.image = "marker-blue.png";
        bicon.shadow = "http://www.google.com/mapfiles/shadow50.png";
        bicon.iconSize = new GSize(20, 34);
        bicon.shadowSize = new GSize(37, 34);
        bicon.iconAnchor = new GPoint(9, 34);
        bicon.infoWindowAnchor = new GPoint(9, 2);
        bicon.infoShadowAnchor = new GPoint(18, 25);
        
        var requestSepta = GXmlHttp.create();
        requestSepta.open("GET", "http://daily.swarthmore.edu/static/xml/septa.xml", true);
        requestSepta.onreadystatechange = function() {
        	if (requestSepta.readyState == 4) {
        		var xmlDoc = GXml.parse(requestSepta.responseText);
        		var points = xmlDoc.documentElement.getElementsByTagName("point");
        		for (var i = 0; i < points.length; i++) {
        			var point = new GPoint(parseFloat(points[i].getAttribute("lng")),
        			parseFloat(points[i].getAttribute("lat")));
        			var text = points[i].getAttribute("txt");
        			var marker = createMarker(point, text + '<BR><form method="GET" action="http://maps.google.com/maps" target="_blank"><span style="font-size: 10pt; color: #888">Get directions to here from:<BR></span><input type=text name=saddr size=25 style="font-size: 10pt"><input type=hidden name=daddr value=' + point.y + ',' + point.x + '> <input type=submit value="Go" style="padding: 0px"><input type=hidden name=hl value=en></form>', bicon);
                                map.addOverlay(marker);
        requestSepta.send(null);
        {% endifequal %}
        
        {% ifequal establishment.access "w" %}
            directionsPanel = document.getElementById("route");
            directions = new GDirections(map, directionsPanel);
            travelType = G_TRAVEL_MODE_WALKING
            directions.load("from: 500 College Ave, Swarthmore PA to: {{ establishment.street_address }}, {{ establishment.city }}",{travelMode:travelType});
        {% else %}
            {% ifequal establishment.access "p" %}
                {% ifequal establishment.city "Philadelphia" %}
                    travelType = G_TRAVEL_MODE_WALKING
                    directions.load("from: Philadelphia 30th Street Station, Philadelphia, PA 19104 to: {{ establishment.street_address }}, {{ establishment.city }}",{travelMode:travelType});
                {% else %}
                    travelType = G_TRAVEL_MODE_DRIVING
                    directions.load("from: 500 College Ave, Swarthmore PA to: {{ establishment.street_address }}, {{ establishment.city }}",{travelMode:travelType});
                {% endifequal %}
            {% else %}
                travelType = G_TRAVEL_MODE_DRIVING
                directions.load("from: 500 College Ave, Swarthmore PA to: {{ establishment.street_address }}, {{ establishment.city }}",{travelMode:travelType});
            {% endifequal %}
        {% endifequal %}
    }
  </script>

{% endblock customheader %}

{% block body-args %}onload="initialize()"{% endblock %}

{% block topbar %}
  <div id="headerSectionBar">
    <div id="headerSearch">
      {% include "search_header.html" %}
    </div>
  </div>
{% endblock topbar %}


{% block content %}
<div id="reviews">
  <h2>{{ establishment.name }}, in the Gazette's Zagette</h2>
  <div id="topBlock">
      <div id="reviewInfo">
          <p><strong>Average Rating:</strong> {{ establishment.avg_rating|default_if_none:"No Ratings" }} | <strong>Average Cost:</strong> {{ establishment.avg_cost|default_if_none:"Unknown" }} | <strong>Tags:</strong> {% for tag in establishment.tags.all %}{{ tag.name }}{% if not forloop.last %}, {% endif %}{% endfor %} | <strong>Phone:</strong> {{ establishment.phone }} | <strong>Address:</strong> {{ establishment.street_address }}, {{ establishment.city }}</p>
      </div>

    <div id="mapBlock">
      <div id="route">
        <!-- Directions inserted here -->
      </div>
      <div id="map" class="jmap">
        
        <!-- Map inserted here -->
        
      </div>
      <div id="reviewText">
          {% for review in establishment.reviews.all %}
            {% if not forloop.first %}<center><hr width="50%" /></center>{% endif %}
            <p><strong>Reviewed by: {{ review.reviewer.name }}</strong> (Cost: {{ review.cost }} Rating: {{ review.rating }})</p>
            <p>{{ review.review_text }}</p>
          {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}