{% extends "base.html" %}
{% load extras %}

{% block title %}Community Guide{% endblock title %}

{% block customheader %}
  <link rel="stylesheet" href="{% static css page/section.css %}" type="text/css"/>
  <link rel="stylesheet" href="{% static css page/reviews.css %}" type="text/css"/>
  
  <script type="text/javascript" src="{% static js tablesort.js %}"></script>
  <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ GMAPS_API_KEY }}" type="text/javascript"></script>
  
  {% jQuery %}
  

  <script type="text/javascript">
var map;
var points = {};
var info = {};

var markerGroups = { {% for short, long in TYPE_CHOICES %}"{{ short }}": []{% if not forloop.last %}, {% endif %}{% endfor %} }

var icons = {};
{% for short, long in TYPE_CHOICES %}
icons['{{ short }}'] = new GIcon();
icons['{{ short }}'].image = '/static/images/reviews/map-markers/{{ short }}.png';
icons['{{ short }}'].shadow = '/static/images/reviews/map-markers/{{ short }}-shadow.png';
icons['{{ short }}'].iconSize = new GSize(32, 32);
icons['{{ short }}'].shadowSize = new GSize(59, 32);
icons['{{ short }}'].iconAnchor = new GPoint(16, 32);
icons['{{ short }}'].infoWindowAnchor = new GPoint(5, 1);
{% endfor %}

function initialize() {
  if (GBrowserIsCompatible()) {
    // Init map
    map = new GMap2(document.getElementById("map"));
    map.setCenter(new GLatLng(39.9034, -75.3529), 15);
          
    // place establishments
    {% for e in establishments %}
    addMarker(
      new GLatLng({{ e.latitude }}, {{ e.longitude }}),
      
      '<large><strong>{{ e.name }}</strong></large><br/>' + 
      'Average Rating: {{ e.avg_rating|default_if_none:"-" }}<br/>' +
      'Average Cost: {{ e.avg_cost|default_if_none:"-" }}<br/>' +
      {% if e.phone %}'Phone: {{ e.phone }}<br/>' + {% endif %}
      '<a href="{{ e.get_absolute_url }}">Read more</a>',
      
      '{{ e.establishment_type }}',
      {{ e.pk }}
    );
    {% endfor %}
  }
}

function addMarker(point, info_box, type, num) {
  var marker = new GMarker(point, icons[type]);
  GEvent.addListener(marker, 'click', function() {
    map.openInfoWindowHtml(point, info_box);
  });
  map.addOverlay(marker);

  points[num] = point;
  info[num] = info_box;
  markerGroups[type].push(marker);
}

function openInfo(num) {
  map.openInfoWindowHtml(points[num], info[num]);
}

// TODO: the table isn't highlighted properly when there are groups hidden
function toggleGroup(type) {
  jQuery.each(markerGroups[type], function() {
    this.isHidden() ? this.show() : this.hide();
  });
  $('#review-listings .row-' + type).toggle();
}

// after reload, checkboxes aren't always checked
$(function() {
  $('#map-menu p :checkbox').each(function() { 
    prefix = 'checkbox-'
    if (this.id.substring(0, prefix.length) == prefix && !this.checked) {
      toggleGroup(this.id.substring(prefix.length));
    }
  });
});

  </script>

{% endblock customheader %}

{% block body-args %}onload="initialize()" onunload="GUnload()"{% endblock %}

{% block topbar %}
  <div id="headerSectionBar">
    <div id="headerSearch">
      {% include "search_header.html" %}
    </div>
  </div>
{% endblock topbar %}


{% block content %}
<div id="reviews">
  <h2>The Zagette</h2>
  {% if submitted_name %}
    <p id="submitted-thanks">Thanks for letting us know about {{ submitted_name }}. Once we've verified the information you gave us, it'll show up here.</p>
  {% endif %}
  <div id="topBlock">
    <div id="mapBlock">
      <div id="map-menu">
        <h3>Categories</h3>
        <table>
            {% for type1, type2 in TYPE_CHOICES|in_groups_of:2 %}
                <tr>
                    <td>
                        <p><input type="checkbox" id="checkbox-{{ type1.0 }}" onclick="toggleGroup('{{ type1.0 }}')" CHECKED /> {{ type1.1 }} </p>
                    </td>
                    <td>
                        <p><input type="checkbox" id="checkbox-{{ type2.0 }}" onclick="toggleGroup('{{ type2.0 }}')" CHECKED /> {{ type2.1 }} </p>
                    </td>
                </tr>
            {% endfor %}
        </table>
            
        <h4>We missing something{% if submitted_name %} else{% endif %}? Let us know.</h4>
        <form method="post" action=".">
          <table width="250px" cellspacing="0px" cellpadding="0px" border="0px">
            {{ submit_form.as_table }}
            <tr>
              <td></td>
              <td><input type="submit" value="Submit" class="default" name="_save" /></td>
            </tr>
          </table>
        </form>
      </div>
      <div id="map" class="jmap">
        
        <!-- Map inserted here -->
        
      </div>
    </div>
  </div>

  <div id="listings">
    <table id="review-listings" cellpadding="0" cellspacing="0" border="0" class="sortable-onload-4-5r rowstyle-alt colstyle-alt no-arrow">
      <caption>Reviews for and by the Swarthmore Community</caption>
      <thead>
        <tr>
          <th class="sortable" width="70px">Type</th>
          <th class="sortable" width="225px">Name</th>
          <th class="sortable" width="50px">Rating</th>
          <th class="sortable" width="50px">Cost</th>
          <th class="sortable" width="100px">City</th>
          <th class="sortable" width="100px">Access</th>
          <th class="sortable" width="75px">Phone</th>
          <th class="sortable" width="100px">Tags</th>
          <th class="sortable" width="115px">Reviews</th>
        </tr>
      </thead>
      <tbody>
        {% for establishment in establishments %}
          <tr class="row-{{ establishment.establishment_type }}">
            <td>{{ establishment.get_establishment_type_display }}</td>
            <td><a href="#" onclick='openInfo({{ establishment.pk }}); return false'>{{ establishment.name }}</a></td>
            <td>{{ establishment.avg_rating|default_if_none:"" }}</td>
            <td>{{ establishment.avg_cost|default_if_none:"" }}</td>
            <td>{{ establishment.city }}</td>
            <td>{{ establishment.get_access_display }}</td>
            <td>{{ establishment.phone }}</td>
            <td>{{ establishment.tag_names }}</td>
            <td>
              {% for review in establishment.reviews.all %}
                <a href="{{ review.get_absolute_url }}">{{ review.reviewer.name }}</a>
                {% if not forloop.last %}<br />{% endif %}
              {% endfor %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}
