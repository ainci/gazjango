{% extends "base.html" %}
{% load extras %}

{% block title %}Community Guide{% endblock title %}

{% block customheader %}
  <link rel="stylesheet" href="{% static css page/section.css %}" type="text/css"/>
  <link rel="stylesheet" href="{% static css page/reviews.css %}" type="text/css"/>
  
  <script type="text/javascript" src="{% static js tablesort.js %}"></script>
  <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key={{ GMAPS_API_KEY }}" type="text/javascript"></script>
  
  {% jQuery %}
  

  <script type="text/javascript">
var markerGroups = { {% for short, long in TYPE_CHOICES %}"{{short}}": []{% if not forloop.last %}, {% endif %}{% endfor %} }

var points = new Array();
var info = new Array();

{% for short, long in TYPE_CHOICES %}
var icon{{ short }} = new GIcon(); 
    icon{{ short }}.image = '/static/images/reviews/map-markers/{{ short }}.png';
    icon{{ short }}.shadow = '/static/images/{{ short }}-shadow.png';
    icon{{ short }}.iconSize = new GSize(32, 32);
    icon{{ short }}.shadowSize = new GSize(59, 32);
    icon{{ short }}.iconAnchor = new GPoint(16, 32);
    icon{{ short }}.infoWindowAnchor = new GPoint(5, 1);

{% endfor %}


function initialize() {
  if (GBrowserIsCompatible()) {
    // Init map
    var map = new GMap2(document.getElementById("map"));
    map.setCenter(new GLatLng(39.9034, -75.3529), 15);
          
    // place establishments
      {% for establishment in establishments %}
        var point = new GLatLng({{ establishment.latitude }},{{ establishment.longitude }});
        var info_box = '<large><strong>{{ establishment.name }}</strong></large>. Average Rating of {{ establishment.avg_rating }} and cost of {{ establishment.avg_cost }}. Phone: {{ establishment.phone }}. Read more at the <a href="#">establishment page</a>.'
        var icon = icon{{ establishment.establishment_type }}
        
        points[{{ forloop.counter }}] = point;
        info[{{ forloop.counter }}] = info_box;
        
        var point{{ establishment.pk }} = createMarker(point,info_box,icon);
        map.addOverlay(point{{ establishment.pk }});
        markerGroups['{{ establishment.establishment_type }}'].push(point{{ establishment.pk }})
      {% endfor %}
  }
}

function createMarker(point, info_box, type) {
    var marker = new google.maps.Marker(point,type);

    google.maps.Event.addListener(marker, 'click', function() {
        map.openInfoWindowHtml(point, info_box);
        });

    return marker;
}

function openInfo(num) {
    map.openInfoWindowHtml(points[num], info[num]);
}

// TODO: the table isn't highlighted properly when there are groups hidden
function toggleGroup(type) {
  jQuery.each(markerGroups[type], function() {
    this.isHidden() ? this.show() : this.hide();
  });
  $('#review-listings .row-' + type).toggle();
}

// after reload, checkboxes aren't always checked
$(function() {
  $('#map-menu p :checkbox').each(function() { 
    prefix = 'checkbox-'
    if (this.id.substring(0, prefix.length) == prefix && !this.checked) {
      toggleGroup(this.id.substring(prefix.length));
    }
  });
});

  </script>

{% endblock customheader %}

{% block body-args %}onload="initialize()" onunload="GUnload()"{% endblock %}

{% block topbar %}
  <div id="headerSectionBar">
    <div id="headerSearch">
      {% include "search_header.html" %}
    </div>
  </div>
{% endblock topbar %}


{% block content %}
<div id="reviews">
  <h2>The Zagette</h2>
  {% if submitted_name %}
    <p id="submitted-thanks">Thanks for letting us know about {{ submitted_name }}. Once we've verified the information you gave us, it'll show up here.</p>
  {% endif %}
  <div id="topBlock">
    <div id="sideBar">
    </div>
    <div id="mapBlock">
      <div id="map-menu">
        <h3>Categories</h3>
        {% for short, long in TYPE_CHOICES %}
          <p><input type="checkbox" id="checkbox-{{ short }}" onclick="toggleGroup('{{ short }}')" CHECKED /> {{ long }} </p>
        {% endfor %}
        
        <h4>We missing something{% if submitted_name %} else{% endif %}? Let us know.</h4>
        <form method="post" action=".">
          <table width="250px" cellspacing="0px" cellpadding="0px" border="0px">
            {{ submit_form.as_table }}
            <tr>
              <td></td>
              <td><input type="submit" value="Submit" class="default" name="_save" /></td>
            </tr>
          </table>
        </form>
      </div>
      
      <div id="map" class="jmap"></div>
    </div>
  </div>

  <div id="listings">
    <table id="review-listings" cellpadding="0" cellspacing="0" border="0" class="sortable-onload-5-6r rowstyle-alt colstyle-alt no-arrow">
      <caption>Reviews from the Swarthmore Area</caption>
      <thead>
        <tr>
          <th class="sortable">Type</th>
          <th class="sortable">Name</th>
          <th class="sortable">Rating</th>
          <th class="sortable">Cost</th>
          <th class="sortable">City</th>
          <th class="sortable">Access</th>
          <th class="sortable">Tags</th>
          <th class="sortable">Reviews</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for establishment in establishments %}
          <tr class="row-{{ establishment.establishment_type }}">
            <td>{{ establishment.get_establishment_type_display }}</td>
            <td><a href="#" onclick='openInfo(point{{ establishment.pk }}); return false'>{{ establishment.name }}</a></td>
            <td>{{ establishment.avg_rating }}</td>
            <td>{{ establishment.avg_cost }}</td>
            <td>{{ establishment.city }}</td>
            <td>{{ establishment.get_access_display }}</td>
            <td>{{ establishment.tag_names }}</td>
            <td>
              {% for review in establishment.reviews.all %}
                <a href="{{ review.get_absolute_url }}">{{ review.reviewer }}</a>
                <br />
              {% endfor %}
            </td>
            <td>{{ establishment.other_info }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}
